<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MeshWave</title>
<style>
:root {
  --bg-dark: #111b21;
  --bg-panel: #202c33;
  --bg-sidebar: #111b21;
  --bg-chat: #0b141a;
  --bg-input: #2a3942;
  --bg-bubble-out: #005c4b;
  --bg-bubble-in: #202c33;
  --border: #2a3942;
  --text: #e9edef;
  --text-muted: #8696a0;
  --accent: #00a884;
  --accent-hover: #00c49a;
  --danger: #ea4335;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-dark);
  color: var(--text);
  height: 100vh;
  overflow: hidden;
}

/* â”€â”€ Mode Selection Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.85);
  display: flex; align-items: center; justify-content: center;
  z-index: 1000;
}
.modal {
  background: var(--bg-panel);
  border-radius: 12px;
  padding: 40px;
  text-align: center;
  max-width: 460px;
  width: 90%;
}
.modal h1 { font-size: 28px; margin-bottom: 8px; }
.modal .logo { font-size: 48px; margin-bottom: 12px; }
.modal p { color: var(--text-muted); margin-bottom: 28px; font-size: 14px; }
.modal input {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg-input);
  color: var(--text);
  font-size: 15px;
  margin-bottom: 16px;
  outline: none;
}
.modal input:focus { border-color: var(--accent); }
.modal .btn-group { display: flex; gap: 12px; }
.modal .btn {
  flex: 1;
  padding: 14px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
}
.btn-server { background: var(--accent); color: #fff; }
.btn-server:hover { background: var(--accent-hover); }
.btn-client { background: var(--bg-input); color: var(--text); border: 1px solid var(--border) !important; }
.btn-client:hover { background: var(--border); }

/* â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app { display: flex; height: 100vh; }
.sidebar {
  width: 340px;
  min-width: 300px;
  background: var(--bg-sidebar);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
}
.main-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: var(--bg-chat);
}

/* â”€â”€ Sidebar Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar-header {
  padding: 12px 16px;
  background: var(--bg-panel);
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
}
.sidebar-header h2 { font-size: 18px; font-weight: 600; }
.status-badge {
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 12px;
  background: var(--accent);
  color: #fff;
  font-weight: 600;
}
.status-badge.disconnected { background: var(--danger); }

/* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
}
.tab {
  flex: 1;
  padding: 12px;
  text-align: center;
  cursor: pointer;
  color: var(--text-muted);
  font-size: 14px;
  font-weight: 500;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.tab:hover { color: var(--text); }

/* â”€â”€ Server/Peer Lists â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.list-section {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}
.list-section h3 {
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 8px 12px;
}
.list-item {
  padding: 12px 16px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: background 0.15s;
  margin-bottom: 2px;
}
.list-item:hover { background: var(--bg-panel); }
.list-item.active { background: var(--bg-input); }
.list-item .avatar {
  width: 40px; height: 40px;
  border-radius: 50%;
  background: var(--accent);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 600; color: #fff;
  flex-shrink: 0;
}
.list-item .info { flex: 1; min-width: 0; }
.list-item .info .name { font-size: 15px; font-weight: 500; }
.list-item .info .detail { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.empty-state {
  padding: 40px 20px;
  text-align: center;
  color: var(--text-muted);
  font-size: 14px;
}

/* â”€â”€ Chat Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-header {
  padding: 12px 20px;
  background: var(--bg-panel);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
}
.chat-header .name { font-size: 16px; font-weight: 600; }
.chat-header .status { font-size: 12px; color: var(--text-muted); }
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px 60px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.msg-bubble {
  max-width: 65%;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 14px;
  line-height: 1.4;
  position: relative;
  word-wrap: break-word;
}
.msg-bubble.out {
  align-self: flex-end;
  background: var(--bg-bubble-out);
  border-top-right-radius: 2px;
}
.msg-bubble.in {
  align-self: flex-start;
  background: var(--bg-bubble-in);
  border-top-left-radius: 2px;
}
.msg-bubble .sender {
  font-size: 12px;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 2px;
}
.msg-bubble .time {
  font-size: 11px;
  color: var(--text-muted);
  text-align: right;
  margin-top: 4px;
}
.chat-input-area {
  padding: 12px 20px;
  background: var(--bg-panel);
  border-top: 1px solid var(--border);
  display: flex;
  gap: 12px;
  align-items: center;
}
.chat-input-area input {
  flex: 1;
  padding: 12px 16px;
  border: none;
  border-radius: 8px;
  background: var(--bg-input);
  color: var(--text);
  font-size: 15px;
  outline: none;
}
.chat-input-area button {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  background: var(--accent);
  color: #fff;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s;
}
.chat-input-area button:hover { background: var(--accent-hover); }

.welcome-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--text-muted);
}
.welcome-panel .icon { font-size: 80px; margin-bottom: 16px; }
.welcome-panel h2 { font-size: 24px; color: var(--text); margin-bottom: 8px; }
.welcome-panel p { font-size: 14px; max-width: 400px; text-align: center; }

/* â”€â”€ File Transfer Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.file-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.file-header {
  padding: 16px 20px;
  background: var(--bg-panel);
  border-bottom: 1px solid var(--border);
}
.file-header h3 { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
.file-header p { font-size: 12px; color: var(--text-muted); }

.drop-zone {
  margin: 16px 20px;
  padding: 40px;
  border: 2px dashed var(--border);
  border-radius: 12px;
  text-align: center;
  color: var(--text-muted);
  transition: all 0.2s;
  cursor: pointer;
}
.drop-zone:hover, .drop-zone.dragover {
  border-color: var(--accent);
  background: rgba(0,168,132,0.05);
  color: var(--accent);
}
.drop-zone .icon { font-size: 36px; margin-bottom: 8px; }
.drop-zone .label { font-size: 14px; }
.drop-zone .sublabel { font-size: 12px; margin-top: 4px; }

.send-file-form {
  margin: 0 20px 16px;
  display: flex;
  gap: 8px;
  align-items: center;
}
.send-file-form input {
  flex: 1;
  padding: 10px 14px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg-input);
  color: var(--text);
  font-size: 13px;
  outline: none;
}
.send-file-form select {
  padding: 10px 14px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg-input);
  color: var(--text);
  font-size: 13px;
  outline: none;
}
.send-file-form button {
  padding: 10px 18px;
  border: none;
  border-radius: 8px;
  background: var(--accent);
  color: #fff;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}
.send-file-form button:hover { background: var(--accent-hover); }

.transfer-list {
  flex: 1;
  overflow-y: auto;
  padding: 0 20px 16px;
}
.transfer-list h4 {
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}
.xfer-card {
  background: var(--bg-panel);
  border-radius: 8px;
  padding: 12px 16px;
  margin-bottom: 8px;
  border: 1px solid var(--border);
}
.xfer-card .xfer-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.xfer-card .xfer-name {
  font-size: 14px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
}
.xfer-card .xfer-peer {
  font-size: 12px;
  color: var(--text-muted);
}
.xfer-card .xfer-bar {
  width: 100%;
  height: 6px;
  background: var(--bg-input);
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 6px;
}
.xfer-card .xfer-bar-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 3px;
  transition: width 0.3s;
}
.xfer-card .xfer-bar-fill.error { background: var(--danger); }
.xfer-card .xfer-bar-fill.paused { background: #f59e0b; }
.xfer-card .xfer-bottom {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
  color: var(--text-muted);
}
.xfer-card .xfer-actions button {
  padding: 4px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: transparent;
  color: var(--text);
  font-size: 11px;
  cursor: pointer;
  margin-left: 4px;
}
.xfer-card .xfer-actions button:hover { background: var(--bg-input); }
.xfer-badge {
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 600;
}
.xfer-badge.active { background: var(--accent); color: #fff; }
.xfer-badge.done { background: #22c55e; color: #fff; }
.xfer-badge.error { background: var(--danger); color: #fff; }
.xfer-badge.paused { background: #f59e0b; color: #000; }

.hidden { display: none !important; }
</style>
</head>
<body>

<!-- Mode Selection Modal -->
<div class="modal-overlay" id="modeModal">
  <div class="modal">
    <div class="logo">âš¡</div>
    <h1>MeshWave</h1>
    <p>LAN-native messaging &amp; file sharing. No internet needed.</p>
    <input type="text" id="nameInput" placeholder="Your name" value="User">
    <div class="btn-group">
      <button class="btn btn-server" onclick="startServer()">ğŸ–¥ï¸ Run as Server</button>
      <button class="btn btn-client" onclick="startClient()">ğŸ’» Join as Client</button>
    </div>
  </div>
</div>

<!-- Main App -->
<div class="app hidden" id="app">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>âš¡ MeshWave</h2>
      <span class="status-badge" id="statusBadge">Connected</span>
    </div>
    <div class="tabs">
      <div class="tab active" onclick="switchTab('messages')" id="tabMessages">ğŸ’¬ Messages</div>
      <div class="tab" onclick="switchTab('files')" id="tabFiles">ğŸ“ Files</div>
    </div>
    <div class="list-section" id="listSection">
      <div id="serverList"></div>
      <div id="peerList"></div>
    </div>
  </div>

  <!-- Main Panel -->
  <div class="main-panel" id="mainPanel">
    <div class="welcome-panel" id="welcomePanel">
      <div class="icon">âš¡</div>
      <h2>MeshWave</h2>
      <p>Select a peer from the sidebar to start chatting. Messages stay on your LAN â€” no cloud, no accounts.</p>
    </div>

    <div class="hidden" id="chatPanel">
      <div class="chat-header">
        <div class="avatar" id="chatAvatar">U</div>
        <div>
          <div class="name" id="chatPeerName">Peer</div>
          <div class="status" id="chatPeerStatus">Online</div>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendMessage()">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <!-- Files Panel -->
    <div class="hidden" id="filePanel">
      <div class="file-header">
        <h3>ğŸ“ File Transfer</h3>
        <p>Send files to peers on your LAN. Drag &amp; drop or enter a file path.</p>
      </div>
      <div class="drop-zone" id="dropZone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
        <div class="icon">ğŸ“‚</div>
        <div class="label">Drag &amp; drop files here</div>
        <div class="sublabel">or use the form below to enter a file path</div>
      </div>
      <div class="send-file-form">
        <input type="text" id="filePathInput" placeholder="File path (e.g. /Users/you/file.zip)">
        <select id="filePeerSelect"><option value="">Select peer...</option></select>
        <button onclick="sendFile()">Send</button>
      </div>
      <div class="transfer-list">
        <h4>Transfers</h4>
        <div id="transferList">
          <div class="empty-state">No transfers yet</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const state = {
  mode: null,         // 'server' | 'client'
  username: 'User',
  activePeer: null,
  activeTab: 'messages',
  messages: {},       // { peerName: [{ from, text, ts, dir }] }
  servers: [],
  peers: [],
  transfers: [],      // [{ id, filename, peer, state, done, total, percent }]
  sse: null
};

/* â”€â”€ Mode Selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

async function startServer() {
  const name = document.getElementById('nameInput').value.trim() || 'MeshWave-Server';
  try {
    const res = await fetch('/api/mode', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode: 'server', name })
    });
    const data = await res.json();
    if (data.ok) {
      state.mode = 'server';
      state.username = name;
      enterApp();
    }
  } catch (e) {
    console.error('startServer failed:', e);
  }
}

async function startClient() {
  state.mode = 'client';
  state.username = document.getElementById('nameInput').value.trim() || 'User';
  enterApp();
}

function enterApp() {
  document.getElementById('modeModal').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  updateStatus();
  startSSE();
  if (state.mode === 'client') {
    pollServers();
    setInterval(pollServers, 3000);
  } else {
    setInterval(pollPeers, 3000);
  }
  setInterval(pollTransfers, 5000);
}

/* â”€â”€ Server / Peer Polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

async function pollServers() {
  try {
    const res = await fetch('/api/servers');
    state.servers = await res.json();
    renderServerList();
  } catch (e) {}
}

async function pollPeers() {
  try {
    const res = await fetch('/api/peers');
    state.peers = await res.json();
    renderPeerList();
    if (state.activeTab === 'files') updateFilePeerSelect();
  } catch (e) {}
}

/* â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function renderServerList() {
  const el = document.getElementById('serverList');
  if (state.mode !== 'client') { el.innerHTML = ''; return; }

  let html = '<h3>Servers on LAN</h3>';
  if (state.servers.length === 0) {
    html += '<div class="empty-state">Scanning for servers...</div>';
  }
  state.servers.forEach(s => {
    html += `<div class="list-item" onclick="connectToServer('${s.ip}', ${s.port})">
      <div class="avatar">ğŸ–¥ï¸</div>
      <div class="info">
        <div class="name">${esc(s.name)}</div>
        <div class="detail">${s.ip}:${s.port}</div>
      </div>
    </div>`;
  });
  el.innerHTML = html;
}

function renderPeerList() {
  const el = document.getElementById('peerList');
  let items = state.peers;

  let html = '<h3>Peers</h3>';
  if (items.length === 0) {
    html += '<div class="empty-state">No peers connected yet</div>';
  }
  items.forEach(p => {
    const active = state.activePeer === p.name ? ' active' : '';
    const initial = p.name.charAt(0).toUpperCase();
    html += `<div class="list-item${active}" onclick="selectPeer('${esc(p.name)}')">
      <div class="avatar">${initial}</div>
      <div class="info">
        <div class="name">${esc(p.name)}</div>
        <div class="detail">${p.addr || 'connected'}</div>
      </div>
    </div>`;
  });
  el.innerHTML = html;
}

/* â”€â”€ Connect to Server â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

async function connectToServer(ip, port) {
  try {
    const res = await fetch('/api/mode', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode: 'client', name: state.username, ip, port })
    });
    const data = await res.json();
    if (data.ok) {
      updateStatus();
      setInterval(pollPeers, 3000);
      pollPeers();
    }
  } catch (e) {
    console.error('connect failed:', e);
  }
}

/* â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function selectPeer(name) {
  state.activePeer = name;
  document.getElementById('welcomePanel').classList.add('hidden');
  document.getElementById('chatPanel').classList.remove('hidden');
  document.getElementById('chatPeerName').textContent = name;
  document.getElementById('chatAvatar').textContent = name.charAt(0).toUpperCase();
  renderMessages();
  renderPeerList();
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || !state.activePeer) return;

  try {
    await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ to: state.activePeer, text })
    });
    addMessage(state.activePeer, { from: state.username, text, ts: Date.now(), dir: 'out' });
    input.value = '';
  } catch (e) {
    console.error('send failed:', e);
  }
}

function addMessage(peer, msg) {
  if (!state.messages[peer]) state.messages[peer] = [];
  state.messages[peer].push(msg);
  if (state.activePeer === peer) renderMessages();
}

function renderMessages() {
  const el = document.getElementById('chatMessages');
  const msgs = state.messages[state.activePeer] || [];
  el.innerHTML = msgs.map(m => {
    const dir = m.dir || (m.from === state.username ? 'out' : 'in');
    const time = new Date(m.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    return `<div class="msg-bubble ${dir}">
      ${dir === 'in' ? `<div class="sender">${esc(m.from)}</div>` : ''}
      ${esc(m.text)}
      <div class="time">${time}</div>
    </div>`;
  }).join('');
  el.scrollTop = el.scrollHeight;
}

/* â”€â”€ SSE Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function startSSE() {
  if (state.sse) state.sse.close();
  state.sse = new EventSource('/api/events');

  state.sse.addEventListener('chat', e => {
    try {
      const data = JSON.parse(e.data);
      addMessage(data.from, { from: data.from, text: data.text, ts: data.ts, dir: 'in' });
    } catch (err) {}
  });

  state.sse.addEventListener('file_progress', e => { handleFileEvent(e); });
  state.sse.addEventListener('file_complete', e => { handleFileEvent(e); });
  state.sse.addEventListener('file_error', e => { handleFileEvent(e); });

  state.sse.onerror = () => {
    document.getElementById('statusBadge').textContent = 'Reconnecting...';
    document.getElementById('statusBadge').classList.add('disconnected');
  };

  state.sse.onopen = () => {
    updateStatus();
  };
}

/* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function switchTab(tab) {
  state.activeTab = tab;
  document.getElementById('tabMessages').classList.toggle('active', tab === 'messages');
  document.getElementById('tabFiles').classList.toggle('active', tab === 'files');

  if (tab === 'files') {
    document.getElementById('welcomePanel').classList.add('hidden');
    document.getElementById('chatPanel').classList.add('hidden');
    document.getElementById('filePanel').classList.remove('hidden');
    updateFilePeerSelect();
    pollTransfers();
  } else {
    document.getElementById('filePanel').classList.add('hidden');
    if (state.activePeer) {
      document.getElementById('chatPanel').classList.remove('hidden');
    } else {
      document.getElementById('welcomePanel').classList.remove('hidden');
    }
  }
}

/* â”€â”€ File Transfer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function handleFileEvent(e) {
  try {
    const data = JSON.parse(e.data);
    const idx = state.transfers.findIndex(t => t.id === data.id);
    if (idx >= 0) {
      state.transfers[idx] = data;
    } else {
      state.transfers.push(data);
    }
    renderTransfers();
  } catch (err) {}
}

async function sendFile() {
  const path = document.getElementById('filePathInput').value.trim();
  const to   = document.getElementById('filePeerSelect').value;
  if (!path || !to) return;

  try {
    const res = await fetch('/api/file/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path, to })
    });
    const data = await res.json();
    if (data.ok) {
      document.getElementById('filePathInput').value = '';
      state.transfers.push({
        id: data.id, filename: path.split('/').pop(),
        peer: to, state: 'active', done: 0, total: 0, percent: 0
      });
      renderTransfers();
    }
  } catch (e) {
    console.error('send file failed:', e);
  }
}

async function pauseTransfer(id) {
  try {
    await fetch('/api/file/pause', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id })
    });
  } catch (e) {}
}

async function resumeTransfer(id) {
  try {
    await fetch('/api/file/resume', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id })
    });
  } catch (e) {}
}

async function pollTransfers() {
  try {
    const res = await fetch('/api/transfers');
    state.transfers = await res.json();
    renderTransfers();
  } catch (e) {}
}

function renderTransfers() {
  const el = document.getElementById('transferList');
  if (state.transfers.length === 0) {
    el.innerHTML = '<div class="empty-state">No transfers yet</div>';
    return;
  }

  el.innerHTML = state.transfers.map(t => {
    const badgeClass = t.state || 'active';
    const barClass = t.state === 'error' ? ' error' : t.state === 'paused' ? ' paused' : '';
    const pct = t.percent || 0;

    let actions = '';
    if (t.state === 'active') {
      actions = `<button onclick="pauseTransfer(${t.id})">â¸ Pause</button>`;
    } else if (t.state === 'paused') {
      actions = `<button onclick="resumeTransfer(${t.id})">â–¶ Resume</button>`;
    }

    const icon = t.state === 'done' ? 'âœ…' : t.state === 'error' ? 'âŒ' : 'ğŸ“„';

    return `<div class="xfer-card">
      <div class="xfer-top">
        <div class="xfer-name">${icon} ${esc(t.filename || 'Unknown')}</div>
        <span class="xfer-badge ${badgeClass}">${t.state}</span>
      </div>
      <div class="xfer-bar"><div class="xfer-bar-fill${barClass}" style="width:${pct}%"></div></div>
      <div class="xfer-bottom">
        <span class="xfer-peer">â†” ${esc(t.peer || '')} Â· ${t.done || 0}/${t.total || 0} chunks Â· ${pct}%</span>
        <span class="xfer-actions">${actions}</span>
      </div>
    </div>`;
  }).join('');
}

function updateFilePeerSelect() {
  const sel = document.getElementById('filePeerSelect');
  const current = sel.value;
  sel.innerHTML = '<option value="">Select peer...</option>';
  state.peers.forEach(p => {
    sel.innerHTML += `<option value="${esc(p.name)}">${esc(p.name)}</option>`;
  });
  if (current) sel.value = current;
}

function handleDragOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('dragover');
}

function handleDragLeave(e) {
  e.currentTarget.classList.remove('dragover');
}

function handleDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('dragover');
  if (e.dataTransfer.files.length > 0) {
    const file = e.dataTransfer.files[0];
    document.getElementById('filePathInput').value = file.name;
  }
}

/* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function updateStatus() {
  const badge = document.getElementById('statusBadge');
  badge.textContent = state.mode === 'server' ? 'Server' : 'Client';
  badge.classList.remove('disconnected');
}

function esc(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

/* â”€â”€ Init: check if already running â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(async function init() {
  try {
    const res = await fetch('/api/status');
    const data = await res.json();
    if (data.server_running) {
      state.mode = 'server';
      state.username = 'Server';
      enterApp();
    } else if (data.client_connected) {
      state.mode = 'client';
      state.username = data.username || 'User';
      enterApp();
    }
  } catch (e) {}
})();
</script>
</body>
</html>
