<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MeshWave</title>
<style>
:root {
  --bg-dark: #111b21;
  --bg-panel: #202c33;
  --bg-sidebar: #111b21;
  --bg-chat: #0b141a;
  --bg-input: #2a3942;
  --bg-bubble-out: #005c4b;
  --bg-bubble-in: #202c33;
  --border: #2a3942;
  --text: #e9edef;
  --text-muted: #8696a0;
  --accent: #00a884;
  --accent-hover: #00c49a;
  --danger: #ea4335;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-dark);
  color: var(--text);
  height: 100vh;
  overflow: hidden;
}

/* â”€â”€ Mode Selection Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.85);
  display: flex; align-items: center; justify-content: center;
  z-index: 1000;
}
.modal {
  background: var(--bg-panel);
  border-radius: 12px;
  padding: 40px;
  text-align: center;
  max-width: 460px;
  width: 90%;
}
.modal h1 { font-size: 28px; margin-bottom: 8px; }
.modal .logo { font-size: 48px; margin-bottom: 12px; }
.modal p { color: var(--text-muted); margin-bottom: 28px; font-size: 14px; }
.modal input {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg-input);
  color: var(--text);
  font-size: 15px;
  margin-bottom: 16px;
  outline: none;
}
.modal input:focus { border-color: var(--accent); }
.modal .btn-group { display: flex; gap: 12px; }
.modal .btn {
  flex: 1;
  padding: 14px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
}
.btn-server { background: var(--accent); color: #fff; }
.btn-server:hover { background: var(--accent-hover); }
.btn-client { background: var(--bg-input); color: var(--text); border: 1px solid var(--border) !important; }
.btn-client:hover { background: var(--border); }

/* â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app { display: flex; height: 100vh; }
.sidebar {
  width: 340px;
  min-width: 300px;
  background: var(--bg-sidebar);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
}
.main-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: var(--bg-chat);
}

/* â”€â”€ Sidebar Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar-header {
  padding: 12px 16px;
  background: var(--bg-panel);
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
}
.sidebar-header h2 { font-size: 18px; font-weight: 600; }
.status-badge {
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 12px;
  background: var(--accent);
  color: #fff;
  font-weight: 600;
}
.status-badge.disconnected { background: var(--danger); }

/* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
}
.tab {
  flex: 1;
  padding: 12px;
  text-align: center;
  cursor: pointer;
  color: var(--text-muted);
  font-size: 14px;
  font-weight: 500;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.tab:hover { color: var(--text); }

/* â”€â”€ Server/Peer Lists â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.list-section {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}
.list-section h3 {
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 8px 12px;
}
.list-item {
  padding: 12px 16px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: background 0.15s;
  margin-bottom: 2px;
}
.list-item:hover { background: var(--bg-panel); }
.list-item.active { background: var(--bg-input); }
.list-item .avatar {
  width: 40px; height: 40px;
  border-radius: 50%;
  background: var(--accent);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 600; color: #fff;
  flex-shrink: 0;
}
.list-item .info { flex: 1; min-width: 0; }
.list-item .info .name { font-size: 15px; font-weight: 500; }
.list-item .info .detail { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.empty-state {
  padding: 40px 20px;
  text-align: center;
  color: var(--text-muted);
  font-size: 14px;
}

/* â”€â”€ Chat Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-header {
  padding: 12px 20px;
  background: var(--bg-panel);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
}
.chat-header .name { font-size: 16px; font-weight: 600; }
.chat-header .status { font-size: 12px; color: var(--text-muted); }
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px 60px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.msg-bubble {
  max-width: 65%;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 14px;
  line-height: 1.4;
  position: relative;
  word-wrap: break-word;
}
.msg-bubble.out {
  align-self: flex-end;
  background: var(--bg-bubble-out);
  border-top-right-radius: 2px;
}
.msg-bubble.in {
  align-self: flex-start;
  background: var(--bg-bubble-in);
  border-top-left-radius: 2px;
}
.msg-bubble .sender {
  font-size: 12px;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 2px;
}
.msg-bubble .time {
  font-size: 11px;
  color: var(--text-muted);
  text-align: right;
  margin-top: 4px;
}
.chat-input-area {
  padding: 12px 20px;
  background: var(--bg-panel);
  border-top: 1px solid var(--border);
  display: flex;
  gap: 12px;
  align-items: center;
}
.chat-input-area input {
  flex: 1;
  padding: 12px 16px;
  border: none;
  border-radius: 8px;
  background: var(--bg-input);
  color: var(--text);
  font-size: 15px;
  outline: none;
}
.chat-input-area button {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  background: var(--accent);
  color: #fff;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s;
}
.chat-input-area button:hover { background: var(--accent-hover); }

.welcome-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--text-muted);
}
.welcome-panel .icon { font-size: 80px; margin-bottom: 16px; }
.welcome-panel h2 { font-size: 24px; color: var(--text); margin-bottom: 8px; }
.welcome-panel p { font-size: 14px; max-width: 400px; text-align: center; }

.hidden { display: none !important; }
</style>
</head>
<body>

<!-- Mode Selection Modal -->
<div class="modal-overlay" id="modeModal">
  <div class="modal">
    <div class="logo">âš¡</div>
    <h1>MeshWave</h1>
    <p>LAN-native messaging &amp; file sharing. No internet needed.</p>
    <input type="text" id="nameInput" placeholder="Your name" value="User">
    <div class="btn-group">
      <button class="btn btn-server" onclick="startServer()">ğŸ–¥ï¸ Run as Server</button>
      <button class="btn btn-client" onclick="startClient()">ğŸ’» Join as Client</button>
    </div>
  </div>
</div>

<!-- Main App -->
<div class="app hidden" id="app">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>âš¡ MeshWave</h2>
      <span class="status-badge" id="statusBadge">Connected</span>
    </div>
    <div class="tabs">
      <div class="tab active" onclick="switchTab('messages')" id="tabMessages">ğŸ’¬ Messages</div>
      <div class="tab" onclick="switchTab('files')" id="tabFiles">ğŸ“ Files</div>
    </div>
    <div class="list-section" id="listSection">
      <div id="serverList"></div>
      <div id="peerList"></div>
    </div>
  </div>

  <!-- Main Panel -->
  <div class="main-panel" id="mainPanel">
    <div class="welcome-panel" id="welcomePanel">
      <div class="icon">âš¡</div>
      <h2>MeshWave</h2>
      <p>Select a peer from the sidebar to start chatting. Messages stay on your LAN â€” no cloud, no accounts.</p>
    </div>

    <div class="hidden" id="chatPanel">
      <div class="chat-header">
        <div class="avatar" id="chatAvatar">U</div>
        <div>
          <div class="name" id="chatPeerName">Peer</div>
          <div class="status" id="chatPeerStatus">Online</div>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendMessage()">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
const state = {
  mode: null,         // 'server' | 'client'
  username: 'User',
  activePeer: null,
  messages: {},       // { peerName: [{ from, text, ts, dir }] }
  servers: [],
  peers: [],
  sse: null
};

/* â”€â”€ Mode Selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

async function startServer() {
  const name = document.getElementById('nameInput').value.trim() || 'MeshWave-Server';
  try {
    const res = await fetch('/api/mode', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode: 'server', name })
    });
    const data = await res.json();
    if (data.ok) {
      state.mode = 'server';
      state.username = name;
      enterApp();
    }
  } catch (e) {
    console.error('startServer failed:', e);
  }
}

async function startClient() {
  state.mode = 'client';
  state.username = document.getElementById('nameInput').value.trim() || 'User';
  enterApp();
}

function enterApp() {
  document.getElementById('modeModal').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  updateStatus();
  startSSE();
  if (state.mode === 'client') {
    pollServers();
    setInterval(pollServers, 3000);
  } else {
    setInterval(pollPeers, 3000);
  }
}

/* â”€â”€ Server / Peer Polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

async function pollServers() {
  try {
    const res = await fetch('/api/servers');
    state.servers = await res.json();
    renderServerList();
  } catch (e) {}
}

async function pollPeers() {
  try {
    const res = await fetch('/api/peers');
    state.peers = await res.json();
    renderPeerList();
  } catch (e) {}
}

/* â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function renderServerList() {
  const el = document.getElementById('serverList');
  if (state.mode !== 'client') { el.innerHTML = ''; return; }

  let html = '<h3>Servers on LAN</h3>';
  if (state.servers.length === 0) {
    html += '<div class="empty-state">Scanning for servers...</div>';
  }
  state.servers.forEach(s => {
    html += `<div class="list-item" onclick="connectToServer('${s.ip}', ${s.port})">
      <div class="avatar">ğŸ–¥ï¸</div>
      <div class="info">
        <div class="name">${esc(s.name)}</div>
        <div class="detail">${s.ip}:${s.port}</div>
      </div>
    </div>`;
  });
  el.innerHTML = html;
}

function renderPeerList() {
  const el = document.getElementById('peerList');
  let items = state.peers;

  let html = '<h3>Peers</h3>';
  if (items.length === 0) {
    html += '<div class="empty-state">No peers connected yet</div>';
  }
  items.forEach(p => {
    const active = state.activePeer === p.name ? ' active' : '';
    const initial = p.name.charAt(0).toUpperCase();
    html += `<div class="list-item${active}" onclick="selectPeer('${esc(p.name)}')">
      <div class="avatar">${initial}</div>
      <div class="info">
        <div class="name">${esc(p.name)}</div>
        <div class="detail">${p.addr || 'connected'}</div>
      </div>
    </div>`;
  });
  el.innerHTML = html;
}

/* â”€â”€ Connect to Server â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

async function connectToServer(ip, port) {
  try {
    const res = await fetch('/api/mode', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode: 'client', name: state.username, ip, port })
    });
    const data = await res.json();
    if (data.ok) {
      updateStatus();
      setInterval(pollPeers, 3000);
      pollPeers();
    }
  } catch (e) {
    console.error('connect failed:', e);
  }
}

/* â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function selectPeer(name) {
  state.activePeer = name;
  document.getElementById('welcomePanel').classList.add('hidden');
  document.getElementById('chatPanel').classList.remove('hidden');
  document.getElementById('chatPeerName').textContent = name;
  document.getElementById('chatAvatar').textContent = name.charAt(0).toUpperCase();
  renderMessages();
  renderPeerList();
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || !state.activePeer) return;

  try {
    await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ to: state.activePeer, text })
    });
    addMessage(state.activePeer, { from: state.username, text, ts: Date.now(), dir: 'out' });
    input.value = '';
  } catch (e) {
    console.error('send failed:', e);
  }
}

function addMessage(peer, msg) {
  if (!state.messages[peer]) state.messages[peer] = [];
  state.messages[peer].push(msg);
  if (state.activePeer === peer) renderMessages();
}

function renderMessages() {
  const el = document.getElementById('chatMessages');
  const msgs = state.messages[state.activePeer] || [];
  el.innerHTML = msgs.map(m => {
    const dir = m.dir || (m.from === state.username ? 'out' : 'in');
    const time = new Date(m.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    return `<div class="msg-bubble ${dir}">
      ${dir === 'in' ? `<div class="sender">${esc(m.from)}</div>` : ''}
      ${esc(m.text)}
      <div class="time">${time}</div>
    </div>`;
  }).join('');
  el.scrollTop = el.scrollHeight;
}

/* â”€â”€ SSE Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function startSSE() {
  if (state.sse) state.sse.close();
  state.sse = new EventSource('/api/events');

  state.sse.addEventListener('chat', e => {
    try {
      const data = JSON.parse(e.data);
      addMessage(data.from, { from: data.from, text: data.text, ts: data.ts, dir: 'in' });
    } catch (err) {}
  });

  state.sse.onerror = () => {
    document.getElementById('statusBadge').textContent = 'Reconnecting...';
    document.getElementById('statusBadge').classList.add('disconnected');
  };

  state.sse.onopen = () => {
    updateStatus();
  };
}

/* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function switchTab(tab) {
  document.getElementById('tabMessages').classList.toggle('active', tab === 'messages');
  document.getElementById('tabFiles').classList.toggle('active', tab === 'files');
}

/* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function updateStatus() {
  const badge = document.getElementById('statusBadge');
  badge.textContent = state.mode === 'server' ? 'Server' : 'Client';
  badge.classList.remove('disconnected');
}

function esc(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

/* â”€â”€ Init: check if already running â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(async function init() {
  try {
    const res = await fetch('/api/status');
    const data = await res.json();
    if (data.server_running) {
      state.mode = 'server';
      state.username = 'Server';
      enterApp();
    } else if (data.client_connected) {
      state.mode = 'client';
      state.username = data.username || 'User';
      enterApp();
    }
  } catch (e) {}
})();
</script>
</body>
</html>
